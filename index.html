<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --card-bg: #1a1a1a;
            --text-color: #ffffff;
            --button-color: #248bcf;
            --hint-color: #aaaaaa;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            margin: 0; padding: 15px;
        }
        .screen { display: none; }
        .active { display: block; }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #333;
        }
        .btn-pay {
            background: var(--card-bg);
            border: 2px solid #333;
            color: white;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-pay:active { border-color: var(--button-color); background: #222; }
        .crypto-icon { width: 24px; height: 24px; }
        
        /* Estilos del contador */
        .controls { display: flex; align-items: center; gap: 10px; }
        .btn-circle { width: 30px; height: 30px; border-radius: 50%; border: none; background: var(--button-color); color: white; cursor: pointer; }
    </style>
</head>
<body>

    <div id="screen-catalog" class="screen active">
        <h2 style="text-align: center;">Mis Servicios</h2>
        <div id="catalog-list"></div>
    </div>

    <div id="screen-payment" class="screen">
        <h2 style="text-align: center;">Selecciona Moneda</h2>
        
        <button class="btn-pay" onclick="finalizarPago('usdc')">
            <img class="crypto-icon" src="https://cryptologos.cc/logos/usd-coin-usdc-logo.png"> USDC
        </button>
        <button class="btn-pay" onclick="finalizarPago('usdt')">
            <img class="crypto-icon" src="https://cryptologos.cc/logos/tether-usdt-logo.png"> USDT
        </button>
        <button class="btn-pay" onclick="finalizarPago('eth')">
            <img class="crypto-icon" src="https://cryptologos.cc/logos/ethereum-eth-logo.png"> ETH
        </button>
        <button class="btn-pay" onclick="finalizarPago('btc')">
            <img class="crypto-icon" src="https://cryptologos.cc/logos/bitcoin-btc-logo.png"> BTC
        </button>
        <button class="btn-pay" onclick="finalizarPago('sol')">
            <img class="crypto-icon" src="https://cryptologos.cc/logos/solana-sol-logo.png"> Solana
        </button>

        <p style="text-align: center; color: var(--hint-color);" onclick="irACatalogo()">← Volver al catálogo</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const servicios = [
            { id: 1, nombre: "Servicio 1", precio: 10 },
            { id: 2, nombre: "Servicio 2", precio: 20 },
            { id: 3, nombre: "Servicio 3", precio: 30 },
            { id: 4, nombre: "Servicio 4", precio: 40 }
        ];

        let carrito = {};

        function renderCatalog() {
            const container = document.getElementById('catalog-list');
            container.innerHTML = servicios.map(s => `
                <div class="card">
                    <div><b>${s.nombre}</b><br><small>$${s.precio}</small></div>
                    <div class="controls">
                        <button class="btn-circle" onclick="cambiarCantidad(${s.id}, -1)">-</button>
                        <span>${carrito[s.id] || 0}</span>
                        <button class="btn-circle" onclick="cambiarCantidad(${s.id}, 1)">+</button>
                    </div>
                </div>
            `).join('');
        }

        function cambiarCantidad(id, delta) {
            carrito[id] = (carrito[id] || 0) + delta;
            if (carrito[id] <= 0) delete carrito[id];
            
            let total = 0;
            Object.keys(carrito).forEach(key => {
                const s = servicios.find(srv => srv.id == key);
                total += s.precio * carrito[key];
            });

            if (total > 0) {
                tg.MainButton.setText(`CONTINUAR ($${total.toFixed(2)})`);
                tg.MainButton.show();
            } else {
                tg.MainButton.hide();
            }
            renderCatalog();
        }

        // Al dar clic en CONTINUAR
        tg.onEvent('mainButtonClicked', () => {
            document.getElementById('screen-catalog').classList.remove('active');
            document.getElementById('screen-payment').classList.add('active');
            tg.MainButton.hide(); // Ocultamos el botón para que elija moneda
            tg.BackButton.show(); // Mostramos botón de volver de Telegram
        });

        tg.onEvent('backButtonClicked', () => irACatalogo());

        function irACatalogo() {
            document.getElementById('screen-payment').classList.remove('active');
            document.getElementById('screen-catalog').classList.add('active');
            tg.BackButton.hide();
            tg.MainButton.show();
        }

        function finalizarPago(moneda) {
    tg.MainButton.showProgress();
    
    let totalMonto = 0;
    let serviciosSeleccionados = []; // 1. Inicializamos la lista vacía

    // 2. Llenamos la lista RECORRIENDO el carrito actual
    Object.keys(carrito).forEach(id => {
        const srv = servicios.find(s => s.id == parseInt(id));
        if (srv) {
            const cantidad = carrito[id];
            totalMonto += srv.precio * cantidad;
            // Guardamos el texto: ej. "2x Servicio 1"
            serviciosSeleccionados.push(`${cantidad}x ${srv.nombre}`); 
        }
    });

    // 3. Enviamos a n8n
    fetch('https://n8n.srv1211656.hstgr.cloud/webhook-test/c1ccc323-55d3-4ae7-bc93-800ab6d07cf7', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user: tg.initDataUnsafe.user,
            total: totalMonto,
            currency: moneda,
            servicios_nombres: serviciosSeleccionados.join(', ') // 4. Aquí se unen los nombres
        })
    })
    .then(res => res.json())
    .then(data => {
        tg.MainButton.hideProgress();
        if(data.payment_url) tg.openLink(data.payment_url);
    })
    .catch(err => {
        tg.MainButton.hideProgress();
        tg.showAlert("Error al conectar con el servidor");
    });
}

        renderCatalog();
    </script>
</body>
</html>




